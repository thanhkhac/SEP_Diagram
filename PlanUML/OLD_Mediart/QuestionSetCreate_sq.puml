@startuml
title Sequence Diagram - CreateQuestionSet (MediatR Pipeline)

' Skin parameters for better aesthetics
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontSize 14
skinparam ParticipantPadding 20
skinparam BoxPadding 10

actor Client
participant "Web API\n(Endpoint)" as Web
participant "CurrentUser\n(IUser)" as CurrentUser
participant "MediatR" as MediatR
participant "UnhandledExceptionBehaviour" as Unhandled
participant "AuthorizationBehaviour" as Authorization
participant "ValidationBehaviour" as Validation
participant "PerformanceBehaviour" as Performance
participant "CreateQuestionSetCommandHandler" as Handler
participant "ApplicationDbContext" as DbContext

Client -> Web: HTTP POST /api/questionsets/CreateQuestionSet
activate Web

Web -> CurrentUser: Get User Info
activate CurrentUser
CurrentUser --> Web: UserContext
deactivate CurrentUser

Web -> MediatR: Send(CreateQuestionSetCommand)
activate MediatR

MediatR -> Unhandled: Handle
activate Unhandled

Unhandled -> Authorization: next()
activate Authorization

Authorization -> Authorization: Check [Authorize]
alt Authorized
    Authorization -> Validation: next()
    deactivate Authorization

    activate Validation
    Validation -> Validation: Validate input
    alt Valid
        Validation -> Performance: next()
        deactivate Validation

        activate Performance
        Performance -> Performance: Start Stopwatch
        Performance -> Handler: next()
        activate Handler

        Handler -> DbContext: Add()
        activate DbContext
        DbContext --> Handler: OK
        deactivate DbContext

        Handler --> Performance: Result
        deactivate Handler

        Performance -> Performance: Stop Stopwatch\nLog if > 500ms
        Performance --> Validation: Result
        deactivate Performance

        Validation --> Authorization: Result
        Authorization --> Unhandled: Result
        Unhandled --> MediatR: Result
        deactivate Unhandled

        MediatR --> Web: Result
        deactivate MediatR

        Web --> Client: HTTP 200 OK
        deactivate Web

    else Invalid
        Validation --> Unhandled: throw ErrorCodeException
        deactivate Validation

        Unhandled -> Unhandled: Log Exception
        Unhandled --> MediatR: ErrorCodeException
        deactivate Unhandled

        MediatR --> Web: ErrorCodeException
        deactivate MediatR

        Web --> Client: HTTP 400 Bad Request
        deactivate Web
        note over Client: End due to validation failure
    end alt

else Unauthorized
    Authorization --> Unhandled: throw ErrorCodeException
    deactivate Authorization

    Unhandled -> Unhandled: Log Exception
    Unhandled --> MediatR: ErrorCodeException
    deactivate Unhandled

    MediatR --> Web: ErrorCodeException
    deactivate MediatR

    Web --> Client: HTTP 400 Bad Request
    deactivate Web
    note over Client: End due to unauthorized access
end alt

@enduml
