@startuml
title Sequence Diagram - UpdateQuestionSet (MediatR Pipeline + Ownership Check)

skinparam monochrome true
skinparam shadowing false
skinparam defaultFontSize 14
skinparam ParticipantPadding 20
skinparam BoxPadding 10

actor Client 
participant "Web API\n(Endpoint)" as Web
participant "MediatR" as MediatR
participant "AuthorizationBehaviour" as Authorization
participant "ValidationBehaviour" as Validation
participant "UpdateQuestionSetCommandHandler" as Handler
participant "ApplicationDbContext" as DbContext

Client -> Web: HTTP PUT /api/questionsets/{id}
activate Web

Web -> MediatR: Send(UpdateQuestionSetCommand)
activate MediatR

MediatR -> Authorization: Handle
activate Authorization

Authorization -> Authorization: Check [Authorize]
alt Authorized
    Authorization -> Validation: next()
    deactivate Authorization
    
    activate Validation
    Validation -> Validation: Validate input
    alt Valid
        Validation -> Handler: next()
        deactivate Validation

        activate Handler
        Handler -> DbContext: Get Query
        DbContext --> Handler: Result
        alt invalid permission 
            Handler --> MediatR: throw ForbiddenAccessException
            deactivate Handler

            MediatR --> Web: ForbiddenAccessException
            deactivate MediatR

            Web --> Client: HTTP 400
            deactivate Web
            note over Client: End - Not Owner
        else valid permission 
            Handler -> DbContext: Save
            DbContext --> Handler: OK
            Handler --> MediatR: Result
            deactivate Handler

            MediatR --> Web: Result
            deactivate MediatR

            Web --> Client: HTTP 200 OK
            deactivate Web
        end alt
    else Invalid
        Validation --> MediatR: throw ErrorCodeException
        deactivate Validation

        MediatR --> Web: ErrorCodeException
        deactivate MediatR

        Web --> Client: HTTP 400 Bad Request
        deactivate Web
        note over Client: End due to validation error
    end alt
else Unauthorized
    Authorization --> MediatR: throw ErrorCodeException
    deactivate Authorization

    MediatR --> Web: ErrorCodeException
    deactivate MediatR

    Web --> Client: HTTP 400 
    deactivate Web
    note over Client: End due to unauthorized access
end alt
@enduml
