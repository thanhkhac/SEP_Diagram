@startuml
actor User
participant UI
participant AuthenticationEndpoints
participant ChangePasswordHandler
participant IdentityService
participant UserManager
participant Database

User -> UI : Nhập mật khẩu cũ, mật khẩu mới, nhấn xác nhận
UI -> AuthenticationEndpoints : POST /api/Authentication/ChangePassword
AuthenticationEndpoints -> ChangePasswordHandler : Handle(command)
ChangePasswordHandler -> IdentityService : ChangePasswordAsync(userId, currentPassword, newPassword)
IdentityService -> UserManager : FindByIdAsync(userId)
UserManager -> Database : Query UserAccount
Database --> UserManager : UserAccount/null
alt User not found
    IdentityService --> ChangePasswordHandler : Error: ACCOUNT_NOTFOUND
    ChangePasswordHandler --> AuthenticationEndpoints : Error (ACCOUNT_NOTFOUND)
    AuthenticationEndpoints --> UI : 400 Bad Request (ACCOUNT_NOTFOUND)
    UI -> User : Thông báo lỗi: Không tìm thấy tài khoản
else User found
    IdentityService -> UserManager : ChangePasswordAsync(user, currentPassword, newPassword)
    alt Sai mật khẩu cũ
        UserManager --> IdentityService : Error: ACCOUNT_WRONG_PASSWORD
        IdentityService --> ChangePasswordHandler : Error: ACCOUNT_WRONG_PASSWORD
        ChangePasswordHandler --> AuthenticationEndpoints : Error (ACCOUNT_WRONG_PASSWORD)
        AuthenticationEndpoints --> UI : 400 Bad Request (ACCOUNT_WRONG_PASSWORD)
        UI -> User : Thông báo lỗi: Mật khẩu cũ không đúng
    else Thành công
        UserManager --> IdentityService : Success
        IdentityService --> ChangePasswordHandler : Success
        ChangePasswordHandler --> AuthenticationEndpoints : Success
        AuthenticationEndpoints --> UI : 200 OK
        UI -> User : Thông báo đổi mật khẩu thành công
    end
end
@enduml