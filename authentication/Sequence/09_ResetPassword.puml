@startuml
actor User
participant UI
participant AuthenticationEndpoints
participant ResetPasswordHandler
participant IdentityService
participant UserManager
participant Database

User -> UI : Nhập mã xác thực và mật khẩu mới, nhấn xác nhận
UI -> AuthenticationEndpoints : POST /api/Authentication/ResetPassword
AuthenticationEndpoints -> ResetPasswordHandler : Handle(command)
ResetPasswordHandler -> IdentityService : ResetPasswordAsync(email, code, newPassword)
IdentityService -> UserManager : FindByEmailAsync(email)
UserManager -> Database : Query UserAccount
Database --> UserManager : UserAccount/null
alt User not found
    IdentityService --> ResetPasswordHandler : Error: ACCOUNT_NOTFOUND
    ResetPasswordHandler --> AuthenticationEndpoints : Error (ACCOUNT_NOTFOUND)
    AuthenticationEndpoints --> UI : 400 Bad Request (ACCOUNT_NOTFOUND)
    UI -> User : Thông báo lỗi: Không tìm thấy tài khoản
else User found
    IdentityService -> IdentityService : Check lockout
    alt Quá số lần nhập sai
        IdentityService --> ResetPasswordHandler : Error: PASSWORD_RESET_CODE_FAILED_TOO_MANY
        ResetPasswordHandler --> AuthenticationEndpoints : Error (PASSWORD_RESET_CODE_FAILED_TOO_MANY)
        AuthenticationEndpoints --> UI : 400 Bad Request (PASSWORD_RESET_CODE_FAILED_TOO_MANY)
        UI -> User : Thông báo lỗi: Nhập sai quá nhiều lần
    else Được phép reset
        IdentityService -> IdentityService : Kiểm tra mã và hạn
        alt Mã sai/hết hạn
            IdentityService --> ResetPasswordHandler : Error: ACCOUNT_INVALID_RESET_CODE
            ResetPasswordHandler --> AuthenticationEndpoints : Error (ACCOUNT_INVALID_RESET_CODE)
            AuthenticationEndpoints --> UI : 400 Bad Request (ACCOUNT_INVALID_RESET_CODE)
            UI -> User : Thông báo lỗi: Mã xác thực sai/hết hạn
        else Mã đúng
            IdentityService -> UserManager : ResetPasswordAsync(user, newPassword)
            UserManager -> Database : Update UserAccount
            Database --> UserManager : Success
            IdentityService --> ResetPasswordHandler : Success
            ResetPasswordHandler --> AuthenticationEndpoints : Success
            AuthenticationEndpoints --> UI : 200 OK
            UI -> User : Thông báo đổi mật khẩu thành công
        end
    end
end
@enduml