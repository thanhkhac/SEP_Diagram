@startuml
actor Guest as User
participant "Request reset password UI" as UI
participant AuthenticationEndpoints
participant RequestPasswordResetHandler
participant IdentityService
participant UserManager
participant EmailService
Database Database

User -> UI : Enter email and click "Send password reset code"
activate UI
UI -> AuthenticationEndpoints : POST /api/Authentication/RequestPasswordReset
activate AuthenticationEndpoints
AuthenticationEndpoints -> RequestPasswordResetHandler : Send RequestPasswordResetCommand
activate RequestPasswordResetHandler
RequestPasswordResetHandler -> IdentityService : RequestPasswordResetAsync(email)
activate IdentityService
IdentityService -> UserManager : FindByEmailAsync(email)
activate UserManager
UserManager -> Database : Query UserAccount
activate Database
Database --> UserManager : UserAccount/null
deactivate Database
    UserManager -->IdentityService : UserAccount
    deactivate UserManager
alt User not found

    IdentityService --> RequestPasswordResetHandler : Error: ACCOUNT_NOTFOUND
    RequestPasswordResetHandler --> AuthenticationEndpoints : Error (ACCOUNT_NOTFOUND)
    AuthenticationEndpoints --> UI : 400 Bad Request (ACCOUNT_NOTFOUND)
    UI -> User : Error message: Account not found
else User found
    IdentityService -> IdentityService : Check lockout status
    alt Too many reset requests
        UserManager --> IdentityService : Error: PASSWORD_RESET_REQUEST_TOO_MANY
        deactivate UserManager
        IdentityService --> RequestPasswordResetHandler : Error: PASSWORD_RESET_REQUEST_TOO_MANY
        RequestPasswordResetHandler --> AuthenticationEndpoints : Error (PASSWORD_RESET_REQUEST_TOO_MANY)
        AuthenticationEndpoints --> UI : 400 Bad Request (PASSWORD_RESET_REQUEST_TOO_MANY)
        UI -> User : Error message: Too many reset requests
    else Allowed to send
        IdentityService -> IdentityService : Generate verification code
        IdentityService -> UserManager : UpdateAsync(user)
        activate UserManager
        UserManager -> Database : Update UserAccount
        activate Database
        Database --> UserManager : Success
        deactivate Database
        UserManager --> IdentityService : Success
        deactivate UserManager
        IdentityService -> EmailService : SendEmailAsync(email, subject, body)
        activate EmailService
        EmailService --> IdentityService : Success
        deactivate EmailService
        IdentityService --> RequestPasswordResetHandler : Success
        RequestPasswordResetHandler --> AuthenticationEndpoints : Success
        AuthenticationEndpoints --> UI : 200 OK
        UI -> User : Info message: Password reset code sent
    end
end
deactivate IdentityService
deactivate RequestPasswordResetHandler
deactivate AuthenticationEndpoints
deactivate UI
@enduml