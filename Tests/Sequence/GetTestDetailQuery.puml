@startuml
actor User
participant "Test Detail UI" as UI
participant TestEndpoints
participant GetTestDetailQueryHandler as Handler
participant TestService
participant ApplicationDbContext
participant Database

User -> UI : Open test detail
UI -> TestEndpoints : GET /api/Test/{TestId}
TestEndpoints -> Handler : Handle(GetTestDetailQuery)
Handler -> ApplicationDbContext : Query Test by TestId (Include TestVersions)
ApplicationDbContext -> Database : Query Test, TestVersions
Database --> ApplicationDbContext : Test, List<TestVersion>
ApplicationDbContext --> Handler : Test
alt Test Not Found
    Handler --> TestEndpoints : Error: TEST_NOT_FOUND
    TestEndpoints --> UI : 400 Bad Request (errorCode: TEST_NOT_FOUND)
    UI -> User : Error: Test not found
else Test Found
    Handler -> TestService : CanViewOrEditTest(classId)
    TestService -> ApplicationDbContext : Query Permission
    ApplicationDbContext -> Database : Query Permission
    Database --> ApplicationDbContext : Permission
    ApplicationDbContext --> TestService : Permission
    TestService --> Handler : bool
    alt No permission
        Handler --> TestEndpoints : Error: USER_NOT_HAVE_PERMISSION_IN_TEST
        TestEndpoints --> UI : 400 Bad Request (errorCode: USER_NOT_HAVE_PERMISSION_IN_TEST)
        UI -> User : Error: User does not have permission to view this test
    else Allowed
        Handler -> ApplicationDbContext : Query TestVersionQuestions (for version 0, Include Question)
        ApplicationDbContext -> Database : Query TestVersionQuestions, Question
        Database --> ApplicationDbContext : List<TestVersionQuestion>, List<Question>
        ApplicationDbContext --> Handler : List<QuestionResponseDto>
        Handler --> TestEndpoints : TestDetailDto
        TestEndpoints --> UI : 200 OK (ApiResponse<TestDetailDto>)
        UI -> User : Show test detail
    end
end
@enduml