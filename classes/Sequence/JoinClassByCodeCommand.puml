@startuml
actor User
participant "Join Class UI" as UI
participant ClassEndpoints
participant JoinClassByCodeCommandHandler as Handler
participant ApplicationDbContext
participant Database

User -> UI : Enter invite code, click "Join"
UI -> ClassEndpoints : POST /api/Class/Students
ClassEndpoints -> Handler : Handle(JoinClassByCodeCommand)
Handler -> ApplicationDbContext : Query ClassInvitation by Code
ApplicationDbContext -> Database : Query ClassInvitation
Database --> ApplicationDbContext : ClassInvitation
ApplicationDbContext --> Handler : ClassInvitation
alt Class Invitation Not Found or Expired
    Handler --> ClassEndpoints : Error: CLASS_CODE_NOT_FOUND
    ClassEndpoints --> UI : 400 Bad Request (errorCode: CLASS_CODE_NOT_FOUND)
    UI -> User : Error: Invite code not found or expired
else Class Invitation Found
    Handler -> ApplicationDbContext : Query Class by ClassInvitation.ClassId
    ApplicationDbContext -> Database : Query Class
    Database --> ApplicationDbContext : Class
    ApplicationDbContext --> Handler : Class
    alt Class Not Found
        Handler --> ClassEndpoints : Error: CLASS_NOTFOUND
        ClassEndpoints --> UI : 400 Bad Request (errorCode: CLASS_NOTFOUND)
        UI -> User : Error: Class not found
    else Class Found
        Handler -> ApplicationDbContext : Query ClassUser by UserId and ClassId
        ApplicationDbContext -> Database : Query ClassUser
        Database --> ApplicationDbContext : ClassUser
        ApplicationDbContext --> Handler : ClassUser
        alt User Already In Class
            Handler --> ClassEndpoints : Error: STUDENT_ALREADY_EXISTS_IN_CLASS
            ClassEndpoints --> UI : 400 Bad Request (errorCode: STUDENT_ALREADY_EXISTS_IN_CLASS)
            UI -> User : Error: Student already in class
        else User Not In Class
            Handler -> ApplicationDbContext : Add new ClassUser and ClassInvitationUser
            ApplicationDbContext -> Database : Insert ClassUser, ClassInvitationUser
            Database --> ApplicationDbContext : Success
            ApplicationDbContext --> Handler : Unit
            Handler --> ClassEndpoints : Unit
            ClassEndpoints --> UI : 200 OK (ApiResponse<Unit>)
            UI -> User : Info: Joined class successfully
        end
    end
end

@enduml