@startuml
actor "Lecturer" as User
participant "Class Detail UI" as UI <<UI>>
participant ":ClassEndpoints" as ClassEndpoints <<Controller>>
participant ":RemoveQuestionSetFromClassCommandHandler" as RemoveQuestionSetFromClassCommandHandler <<Handler>>
participant ":ClassService" as ClassService <<Service>>
participant ":ApplicationDbContext" as ApplicationDbContext <<DbContext>>
participant Database

note right of RemoveQuestionSetFromClassCommandHandler
  Managed by MediatR
end note

note right of ClassService
  Managed by IoC
end note

note right of ApplicationDbContext
  Managed by IoC
end note

User -> UI : Select question set, click "Remove from Class"
activate UI
UI -> ClassEndpoints : DELETE /api/Class/{ClassId}/Questionsets/{QuestionSetId}
activate ClassEndpoints
ClassEndpoints -> RemoveQuestionSetFromClassCommandHandler : Handle(RemoveQuestionSetFromClassCommand)
deactivate ClassEndpoints
activate RemoveQuestionSetFromClassCommandHandler
RemoveQuestionSetFromClassCommandHandler -> ApplicationDbContext : Query Class by ClassId
deactivate RemoveQuestionSetFromClassCommandHandler
activate ApplicationDbContext
ApplicationDbContext -> Database : Query Class
deactivate ApplicationDbContext
activate Database
Database --> ApplicationDbContext : Class
deactivate Database
activate ApplicationDbContext
ApplicationDbContext --> RemoveQuestionSetFromClassCommandHandler : Class
deactivate ApplicationDbContext
activate RemoveQuestionSetFromClassCommandHandler
alt Class Not Found
    RemoveQuestionSetFromClassCommandHandler -> ClassEndpoints : Error: CLASS_NOTFOUND
    deactivate RemoveQuestionSetFromClassCommandHandler
    activate ClassEndpoints
    ClassEndpoints --> UI : 400 Bad Request { "error": "CLASS_NOTFOUND" }
    deactivate ClassEndpoints
    UI -> User : Display error: Class not found
else Class Found
    activate RemoveQuestionSetFromClassCommandHandler
    RemoveQuestionSetFromClassCommandHandler -> ClassService : IsLecturerOrOwnerInClass(classId)
    deactivate RemoveQuestionSetFromClassCommandHandler
    activate ClassService
    ClassService -> ApplicationDbContext : Query Permission
    deactivate ClassService
    activate ApplicationDbContext
    ApplicationDbContext -> Database : Query Permission
    deactivate ApplicationDbContext
    activate Database
    Database --> ApplicationDbContext : Permission
    deactivate Database
    activate ApplicationDbContext
    ApplicationDbContext --> ClassService : Permission
    deactivate ApplicationDbContext
    activate ClassService
    ClassService --> RemoveQuestionSetFromClassCommandHandler : bool
    deactivate ClassService
    activate RemoveQuestionSetFromClassCommandHandler
    alt Not Lecturer or Owner
        RemoveQuestionSetFromClassCommandHandler -> ClassEndpoints : Error: NOT_FOUND_TEACHER_OR_OWNER_IN_CLASS
        deactivate RemoveQuestionSetFromClassCommandHandler
        activate ClassEndpoints
        ClassEndpoints --> UI : 400 Bad Request { "error": "NOT_FOUND_TEACHER_OR_OWNER_IN_CLASS" }
        deactivate ClassEndpoints
        UI -> User : Display error: Not lecturer or owner of class
    else Allowed
        activate RemoveQuestionSetFromClassCommandHandler
        RemoveQuestionSetFromClassCommandHandler -> ApplicationDbContext : Query ClassQuestionSet by QuestionSetId and ClassId
        deactivate RemoveQuestionSetFromClassCommandHandler
        activate ApplicationDbContext
        ApplicationDbContext -> Database : Query ClassQuestionSet
        deactivate ApplicationDbContext
        activate Database
        Database --> ApplicationDbContext : ClassQuestionSet
        deactivate Database
        activate ApplicationDbContext
        ApplicationDbContext --> RemoveQuestionSetFromClassCommandHandler : ClassQuestionSet
        deactivate ApplicationDbContext
        activate RemoveQuestionSetFromClassCommandHandler
        alt Question Set Not Found in Class
            RemoveQuestionSetFromClassCommandHandler -> ClassEndpoints : Error: QUESTION_SET_NOT_FOUND_IN_CLASS
            deactivate RemoveQuestionSetFromClassCommandHandler
            activate ClassEndpoints
            ClassEndpoints --> UI : 400 Bad Request { "error": "QUESTION_SET_NOT_FOUND_IN_CLASS" }
            deactivate ClassEndpoints
            UI -> User : Display error: Question set not found in class
        else Question Set Found in Class
            activate RemoveQuestionSetFromClassCommandHandler
            RemoveQuestionSetFromClassCommandHandler -> ApplicationDbContext : Remove ClassQuestionSet
            deactivate RemoveQuestionSetFromClassCommandHandler
            activate ApplicationDbContext
            ApplicationDbContext -> Database : Delete ClassQuestionSet
            deactivate ApplicationDbContext
            activate Database
            Database --> ApplicationDbContext : Success
            deactivate Database
            activate ApplicationDbContext
            ApplicationDbContext --> RemoveQuestionSetFromClassCommandHandler : Guid
            deactivate ApplicationDbContext
            activate RemoveQuestionSetFromClassCommandHandler
            RemoveQuestionSetFromClassCommandHandler -> ClassEndpoints : Guid
            deactivate RemoveQuestionSetFromClassCommandHandler
            activate ClassEndpoints
            ClassEndpoints --> UI : 200 OK (ApiResponse<Guid>)
            deactivate ClassEndpoints
            UI -> User : Display info: Question set removed from class
        end
    end
end
deactivate UI

@enduml