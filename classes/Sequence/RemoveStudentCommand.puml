@startuml
actor "Lecturer" as User
participant "Class Members UI" as UI <<UI>>
participant ":ClassEndpoints" as ClassEndpoints <<Controller>>
participant ":RemoveStudentCommandHandler" as RemoveStudentCommandHandler <<Handler>>
participant ":ClassService" as ClassService <<Service>>
participant ":ApplicationDbContext" as ApplicationDbContext <<DbContext>>
participant Database

note right of RemoveStudentCommandHandler
  Managed by MediatR
end note

note right of ClassService
  Managed by IoC
end note

note right of ApplicationDbContext
  Managed by IoC
end note

User -> UI : Select student, click "Remove"
activate UI
UI -> ClassEndpoints : DELETE /api/Class/{ClassId}/Members/{UserId}
activate ClassEndpoints
ClassEndpoints -> RemoveStudentCommandHandler : Handle(RemoveStudentCommand)
deactivate ClassEndpoints
activate RemoveStudentCommandHandler
RemoveStudentCommandHandler -> ApplicationDbContext : Query Class by ClassId
deactivate RemoveStudentCommandHandler
activate ApplicationDbContext
ApplicationDbContext -> Database : Query Class
deactivate ApplicationDbContext
activate Database
Database --> ApplicationDbContext : Class
deactivate Database
activate ApplicationDbContext
ApplicationDbContext --> RemoveStudentCommandHandler : Class
deactivate ApplicationDbContext
activate RemoveStudentCommandHandler
alt Class Not Found
    RemoveStudentCommandHandler -> ClassEndpoints : Error: CLASS_NOTFOUND
    deactivate RemoveStudentCommandHandler
    activate ClassEndpoints
    ClassEndpoints --> UI : 400 Bad Request { "error": "CLASS_NOTFOUND" }
    deactivate ClassEndpoints
    UI -> User : Display error: Class not found
else Class Found
    activate RemoveStudentCommandHandler
    RemoveStudentCommandHandler -> ClassService : IsLecturerOrOwnerInClass(classId)
    deactivate RemoveStudentCommandHandler
    activate ClassService
    ClassService -> ApplicationDbContext : Query Permission
    deactivate ClassService
    activate ApplicationDbContext
    ApplicationDbContext -> Database : Query Permission
    deactivate ApplicationDbContext
    activate Database
    Database --> ApplicationDbContext : Permission
    deactivate Database
    activate ApplicationDbContext
    ApplicationDbContext --> ClassService : Permission
    deactivate ApplicationDbContext
    activate ClassService
    ClassService --> RemoveStudentCommandHandler : bool
    deactivate ClassService
    activate RemoveStudentCommandHandler
    alt No permission
        RemoveStudentCommandHandler -> ClassEndpoints : Error: USER_NOT_HAVE_PERMISSION
        deactivate RemoveStudentCommandHandler
        activate ClassEndpoints
        ClassEndpoints --> UI : 400 Bad Request { "error": "USER_NOT_HAVE_PERMISSION" }
        deactivate ClassEndpoints
        UI -> User : Display error: User does not have permission
    else Allowed
        activate RemoveStudentCommandHandler
        RemoveStudentCommandHandler -> ApplicationDbContext : Query ClassUser by ClassId and UserId
        deactivate RemoveStudentCommandHandler
        activate ApplicationDbContext
        ApplicationDbContext -> Database : Query ClassUser
        deactivate ApplicationDbContext
        activate Database
        Database --> ApplicationDbContext : ClassUser
        deactivate Database
        activate ApplicationDbContext
        ApplicationDbContext --> RemoveStudentCommandHandler : ClassUser
        deactivate ApplicationDbContext
        activate RemoveStudentCommandHandler
        alt Target User Not Found or Is Owner
            RemoveStudentCommandHandler -> ClassEndpoints : Error: NOT_FOUND_USER_IN_CLASS
            deactivate RemoveStudentCommandHandler
            activate ClassEndpoints
            ClassEndpoints --> UI : 400 Bad Request { "error": "NOT_FOUND_USER_IN_CLASS" }
            deactivate ClassEndpoints
            UI -> User : Display error: User not found or not in class
        else Target User Found and Not Owner
            activate RemoveStudentCommandHandler
            RemoveStudentCommandHandler -> ApplicationDbContext : Remove ClassUser
            deactivate RemoveStudentCommandHandler
            activate ApplicationDbContext
            ApplicationDbContext -> Database : Delete ClassUser
            deactivate ApplicationDbContext
            activate Database
            Database --> ApplicationDbContext : Success
            deactivate Database
            activate ApplicationDbContext
            ApplicationDbContext --> RemoveStudentCommandHandler : Guid
            deactivate ApplicationDbContext
            activate RemoveStudentCommandHandler
            RemoveStudentCommandHandler -> ClassEndpoints : Guid
            deactivate RemoveStudentCommandHandler
            activate ClassEndpoints
            ClassEndpoints --> UI : 200 OK (ApiResponse<Guid>)
            deactivate ClassEndpoints
            UI -> User : Display info: Student removed from class
        end
    end
end
deactivate UI

@enduml