@startuml
actor User
participant "Class Members UI" as UI
participant ClassEndpoints
participant RemoveStudentCommandHandler as Handler
participant ClassService
participant ApplicationDbContext
participant Database

User -> UI : Select student, click "Remove"
UI -> ClassEndpoints : DELETE /api/Class/{ClassId}/Members/{UserId}
ClassEndpoints -> Handler : Handle(RemoveStudentCommand)
Handler -> ApplicationDbContext : Query Class by ClassId
ApplicationDbContext -> Database : Query Class
Database --> ApplicationDbContext : Class
ApplicationDbContext --> Handler : Class
alt Class Not Found
    Handler --> ClassEndpoints : Error: CLASS_NOTFOUND
    ClassEndpoints --> UI : 400 Bad Request (errorCode: CLASS_NOTFOUND)
    UI -> User : Error: Class not found
else Class Found
    Handler -> ClassService : IsLecturerOrOwnerInClass(classId)
    ClassService -> ApplicationDbContext : Query Permission
    ApplicationDbContext -> Database : Query Permission
    Database --> ApplicationDbContext : Permission
    ApplicationDbContext --> ClassService : Permission
    ClassService --> Handler : bool
    alt No permission
        Handler --> ClassEndpoints : Error: USER_NOT_HAVE_PERMISSION
        ClassEndpoints --> UI : 400 Bad Request (errorCode: USER_NOT_HAVE_PERMISSION)
        UI -> User : Error: User does not have permission
    else Allowed
        Handler -> ApplicationDbContext : Query ClassUser by ClassId and UserId
        ApplicationDbContext -> Database : Query ClassUser
        Database --> ApplicationDbContext : ClassUser
        ApplicationDbContext --> Handler : ClassUser
        alt Target User Not Found or Is Owner
            Handler --> ClassEndpoints : Error: NOT_FOUND_USER_IN_CLASS
            ClassEndpoints --> UI : 400 Bad Request (errorCode: NOT_FOUND_USER_IN_CLASS)
            UI -> User : Error: User not found or not in class
        else Target User Found and Not Owner
            Handler -> ApplicationDbContext : Remove ClassUser
            ApplicationDbContext -> Database : Delete ClassUser
            Database --> ApplicationDbContext : Success
            ApplicationDbContext --> Handler : Guid
            Handler --> ClassEndpoints : Guid
            ClassEndpoints --> UI : 200 OK (ApiResponse<Guid>)
            UI -> User : Info: Student removed from class
        end
    end
end
@enduml