@startuml
actor User
participant "Class Members UI" as UI
participant ClassEndpoints
participant UpdatePositionCommandHandler as Handler
participant ApplicationDbContext
participant Database

User -> UI : Change member position
UI -> ClassEndpoints : PATCH /api/Class/{ClassId}/Members/{UserId}
ClassEndpoints -> Handler : Handle(UpdatePositionCommand)
Handler -> ApplicationDbContext : Query ClassUsers and Class by ClassId and UserId
ApplicationDbContext -> Database : Query ClassUsers, Class
Database --> ApplicationDbContext : List<ClassUser>, Class
ApplicationDbContext --> Handler : List<ClassUser>, Class
alt Not Class Owner
    Handler --> ClassEndpoints : Error: ONLY_OWNERS_CAN_UPDATE
    ClassEndpoints --> UI : 400 Bad Request (errorCode: ONLY_OWNERS_CAN_UPDATE)
    UI -> User : Error: Only owners can update
else Is Class Owner
    alt Class Not Found
        Handler --> ClassEndpoints : Error: CLASS_NOTFOUND
        ClassEndpoints --> UI : 400 Bad Request (errorCode: CLASS_NOTFOUND)
        UI -> User : Error: Class not found
    else Class Found
        alt Target User Not Found or Is Owner
            Handler --> ClassEndpoints : Error: NOT_FOUND_STUDENT_IN_CLASS
            ClassEndpoints --> UI : 400 Bad Request (errorCode: NOT_FOUND_STUDENT_IN_CLASS)
            UI -> User : Error: Student not found or is owner
        else Target User Found and Not Owner
            alt Position Not Provided
                Handler --> ClassEndpoints : Error: PERMISSION_NOT_FOUND
                ClassEndpoints --> UI : 400 Bad Request (errorCode: PERMISSION_NOT_FOUND)
                UI -> User : Error: Position not provided
            else Position Provided
                Handler -> ApplicationDbContext : Update ClassMember position
                ApplicationDbContext -> Database : Update ClassMember
                Database --> ApplicationDbContext : Success
                ApplicationDbContext --> Handler : UpdatePositionDto
                Handler --> ClassEndpoints : UpdatePositionDto
                ClassEndpoints --> UI : 200 OK (ApiResponse<UpdatePositionDto>)
                UI -> User : Info: Member position updated
            end
        end
    end
end

@enduml