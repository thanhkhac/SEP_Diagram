@startuml
actor "Lecturer" as User
participant "Class Detail UI" as UI <<UI>>
participant ClassEndpoints <<Controller>>
participant AddQuestionSetToClassCommandHandler <<Handler>>
participant ClassService <<Service>>
participant QuestionSetService <<Service>>
participant ApplicationDbContext <<DbContext>>
participant Database

note right of AddQuestionSetToClassCommandHandler
  Managed by MediatR
end note

note right of ClassService
  Managed by IoC
end note

note right of QuestionSetService
  Managed by IoC
end note

note right of ApplicationDbContext
  Managed by IoC
end note

User -> UI : Select question set, click "Add to Class"
activate UI
UI -> ClassEndpoints : POST /api/Class/{ClassId}/Questionsets/{QuestionSetId}
activate ClassEndpoints
ClassEndpoints -> AddQuestionSetToClassCommandHandler : Handle(AddQuestionSetToClassCommand)
deactivate ClassEndpoints
activate AddQuestionSetToClassCommandHandler
AddQuestionSetToClassCommandHandler -> ClassService : GetActiveClass(classId)
deactivate AddQuestionSetToClassCommandHandler
activate ClassService
ClassService -> ApplicationDbContext : Query Class
deactivate ClassService
activate ApplicationDbContext
ApplicationDbContext -> Database : Query Class
deactivate ApplicationDbContext
activate Database
Database --> ApplicationDbContext : Class
deactivate Database
activate ApplicationDbContext
ApplicationDbContext --> ClassService : Class
deactivate ApplicationDbContext
activate ClassService
ClassService --> AddQuestionSetToClassCommandHandler : Class
deactivate ClassService
activate AddQuestionSetToClassCommandHandler
alt Class Not Found
    AddQuestionSetToClassCommandHandler --> ClassEndpoints : Error: CLASS_NOTFOUND
    deactivate AddQuestionSetToClassCommandHandler
    activate ClassEndpoints
    ClassEndpoints --> UI : 400 Bad Request { "error": "CLASS_NOTFOUND" }
    deactivate ClassEndpoints
    UI -> User : Display error: Class not found
else Class Found
    activate AddQuestionSetToClassCommandHandler
    AddQuestionSetToClassCommandHandler -> QuestionSetService : GetActiveQuestionSet(questionSetId)
    deactivate AddQuestionSetToClassCommandHandler
    activate QuestionSetService
    QuestionSetService -> ApplicationDbContext : Query QuestionSet
    deactivate QuestionSetService
    activate ApplicationDbContext
    ApplicationDbContext -> Database : Query QuestionSet
    deactivate ApplicationDbContext
    activate Database
    Database --> ApplicationDbContext : QuestionSet
    deactivate Database
    activate ApplicationDbContext
    ApplicationDbContext --> QuestionSetService : QuestionSet
    deactivate ApplicationDbContext
    activate QuestionSetService
    QuestionSetService --> AddQuestionSetToClassCommandHandler : QuestionSet
    deactivate QuestionSetService
    activate AddQuestionSetToClassCommandHandler
    alt Question Set Not Found
        AddQuestionSetToClassCommandHandler --> ClassEndpoints : Error: QUESTION_SET_NOT_FOUND
        deactivate AddQuestionSetToClassCommandHandler
        activate ClassEndpoints
        ClassEndpoints --> UI : 400 Bad Request { "error": "QUESTION_SET_NOT_FOUND" }
        deactivate ClassEndpoints
        UI -> User : Display error: Question set not found
    else Question Set Found
        activate AddQuestionSetToClassCommandHandler
        AddQuestionSetToClassCommandHandler -> ClassService : CanUserAddQuestionSetToClass(userId, classId)
        deactivate AddQuestionSetToClassCommandHandler
        activate ClassService
        ClassService -> ApplicationDbContext : Query Permission
        deactivate ClassService
        activate ApplicationDbContext
        ApplicationDbContext -> Database : Query Permission
        deactivate ApplicationDbContext
        activate Database
        Database --> ApplicationDbContext : Permission
        deactivate Database
        activate ApplicationDbContext
        ApplicationDbContext --> ClassService : Permission
        deactivate ApplicationDbContext
        activate ClassService
        ClassService --> AddQuestionSetToClassCommandHandler : bool
        deactivate ClassService
        activate AddQuestionSetToClassCommandHandler
        alt No permission
            AddQuestionSetToClassCommandHandler --> ClassEndpoints : Error: COMMON_FORBIDDEN
            deactivate AddQuestionSetToClassCommandHandler
            activate ClassEndpoints
            ClassEndpoints --> UI : 400 Bad Request { "error": "COMMON_FORBIDDEN" }
            deactivate ClassEndpoints
            UI -> User : Display error: No permission
        else Allowed
            activate AddQuestionSetToClassCommandHandler
            AddQuestionSetToClassCommandHandler -> ApplicationDbContext : Query existing ClassQuestionSet
            deactivate AddQuestionSetToClassCommandHandler
            activate ApplicationDbContext
            ApplicationDbContext -> Database : Query ClassQuestionSet
            deactivate ApplicationDbContext
            activate Database
            Database --> ApplicationDbContext : ClassQuestionSet
            deactivate Database
            activate ApplicationDbContext
            ApplicationDbContext --> AddQuestionSetToClassCommandHandler : ClassQuestionSet
            deactivate ApplicationDbContext
            activate AddQuestionSetToClassCommandHandler
            alt Question Set Already Added
                AddQuestionSetToClassCommandHandler --> ClassEndpoints : Error: QUESTION_SET_ALREADY_ADDED_TO_CLASS
                deactivate AddQuestionSetToClassCommandHandler
                activate ClassEndpoints
                ClassEndpoints --> UI : 400 Bad Request { "error": "QUESTION_SET_ALREADY_ADDED_TO_CLASS" }
                deactivate ClassEndpoints
                UI -> User : Display error: Question set already added to class
            else Question Set Not Added
                activate AddQuestionSetToClassCommandHandler
                AddQuestionSetToClassCommandHandler -> ApplicationDbContext : Add new ClassQuestionSet
                deactivate AddQuestionSetToClassCommandHandler
                activate ApplicationDbContext
                ApplicationDbContext -> Database : Insert ClassQuestionSet
                deactivate ApplicationDbContext
                activate Database
                Database --> ApplicationDbContext : Success
                deactivate Database
                activate ApplicationDbContext
                ApplicationDbContext --> AddQuestionSetToClassCommandHandler : Guid
                deactivate ApplicationDbContext
                activate AddQuestionSetToClassCommandHandler
                AddQuestionSetToClassCommandHandler --> ClassEndpoints : Guid
                deactivate AddQuestionSetToClassCommandHandler
                activate ClassEndpoints
                ClassEndpoints --> UI : 200 OK (ApiResponse<Guid>)
                deactivate ClassEndpoints
                UI -> User : Display info: Question set added to class
            end
        end
    end
end

@enduml