@startuml
actor User
participant "Class Detail UI" as UI
participant ClassEndpoints
participant CreateInviteCodeCommandHandler as Handler
participant ClassService
participant ApplicationDbContext
participant Database

User -> UI : Click "Create Invite Code"
UI -> ClassEndpoints : POST /api/Class/{ClassId}/Invitations
ClassEndpoints -> Handler : Handle(CreateInviteCodeCommand)
Handler -> ApplicationDbContext : Query Class by ClassId
ApplicationDbContext -> Database : Query Class
Database --> ApplicationDbContext : Class
ApplicationDbContext --> Handler : Class
alt Class Not Found
    Handler --> ClassEndpoints : Error: CLASS_NOTFOUND
    ClassEndpoints --> UI : 400 Bad Request (errorCode: CLASS_NOTFOUND)
    UI -> User : Error: Class not found
else Class Found
    Handler -> ClassService : IsLecturerOrOwnerInClass(classId)
    ClassService -> ApplicationDbContext : Query Permission
    ApplicationDbContext -> Database : Query Permission
    Database --> ApplicationDbContext : Permission
    ApplicationDbContext --> ClassService : Permission
    ClassService --> Handler : bool
    alt Not Lecturer or Owner
        Handler --> ClassEndpoints : Error: NOT_FOUND_TEACHER_OR_OWNER_IN_CLASS
        ClassEndpoints --> UI : 400 Bad Request (errorCode: NOT_FOUND_TEACHER_OR_OWNER_IN_CLASS)
        UI -> User : Error: Not lecturer or owner of class
    else Is Lecturer or Owner
        Handler -> ApplicationDbContext : Query existing ClassInvitations
        ApplicationDbContext -> Database : Query ClassInvitations
        Database --> ApplicationDbContext : List<ClassInvitation>
        ApplicationDbContext --> Handler : List<ClassInvitation>
        Handler -> ApplicationDbContext : Remove existing ClassInvitations
        Handler -> ApplicationDbContext : Add new ClassInvitation
        ApplicationDbContext -> Database : Delete existing, Insert new ClassInvitation
        Database --> ApplicationDbContext : Success
        ApplicationDbContext --> Handler : ClassCodeDto
        Handler --> ClassEndpoints : ClassCodeDto
        ClassEndpoints --> UI : 200 OK (ApiResponse<ClassCodeDto>)
        UI -> User : Info: Invite code created
    end
end

@enduml