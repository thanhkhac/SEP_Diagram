@startuml
actor AdminUser
participant "Admin Dashboard UI" as UI
participant PlanEndpoints
participant GetRevenueByYearQueryHandler as Handler
participant IdentityService
participant ApplicationDbContext
participant Database

AdminUser -> UI : Request revenue by year
UI -> PlanEndpoints : GET /api/Plan/RevenueByYear?year=...
PlanEndpoints -> Handler : Handle(GetRevenueByYearQuery)
Handler -> IdentityService : IsInAnyRoleAsync(userId, Administrator, Moderator)
IdentityService --> Handler : bool (isAdmin)
alt Not Admin
    Handler --> PlanEndpoints : Error: USER_NOT_HAVE_PERMISSION
    PlanEndpoints --> UI : 400 Bad Request (errorCode: USER_NOT_HAVE_PERMISSION)
    UI -> AdminUser : Error: User does not have permission
else Is Admin
    Handler -> ApplicationDbContext : Query UserSubscriptions by DateStart Year
    ApplicationDbContext -> Database : Query UserSubscriptions
    Database --> ApplicationDbContext : List<UserSubscription>
    ApplicationDbContext --> Handler : List<UserSubscription>
    loop For each month (1 to 12)
        Handler -> Handler : Sum revenue for month
        Handler -> Handler : Add to result list
    end
    Handler --> PlanEndpoints : List<RevenueDto>
    PlanEndpoints --> UI : 200 OK (ApiResponse<List<RevenueDto>>)
    UI -> AdminUser : Show revenue by year
end
@enduml