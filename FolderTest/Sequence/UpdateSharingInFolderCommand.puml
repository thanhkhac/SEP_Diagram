@startuml
actor User
participant "Folder Sharing UI" as UI
participant FolderTestEndpoints
participant UpdateSharingInFolderCommandHandler as Handler
participant FolderTestService
participant ApplicationDbContext
participant Database

User -> UI : Update sharing settings
UI -> FolderTestEndpoints : PATCH /api/Folder/{FolderId}/Sharing
FolderTestEndpoints -> Handler : Handle(UpdateSharingInFolderCommand)
Handler -> ApplicationDbContext : Query Folder by FolderId
ApplicationDbContext -> Database : Query Folder
Database --> ApplicationDbContext : Folder
ApplicationDbContext --> Handler : Folder
alt Folder Not Found
    Handler --> FolderTestEndpoints : Error: FOLDER_NOT_FOUND
    FolderTestEndpoints --> UI : 400 Bad Request (errorCode: FOLDER_NOT_FOUND)
    UI -> User : Error: Folder not found
else Folder Found
    Handler -> FolderTestService : IsOwnerOrEditor(folderId)
    FolderTestService -> ApplicationDbContext : Query Permission
    ApplicationDbContext -> Database : Query Permission
    Database --> ApplicationDbContext : Permission
    ApplicationDbContext --> FolderTestService : Permission
    FolderTestService --> Handler : bool
    alt No permission
        Handler --> FolderTestEndpoints : Error: USER_NOT_HAVE_PERMISSION_IN_FOLDER
        FolderTestEndpoints --> UI : 400 Bad Request (errorCode: USER_NOT_HAVE_PERMISSION_IN_FOLDER)
        UI -> User : Error: User does not have permission in folder
    else Allowed
        Handler -> ApplicationDbContext : Query existing DomainUsers for SharingModels
        ApplicationDbContext -> Database : Query DomainUsers
        Database --> ApplicationDbContext : List<DomainUser>
        ApplicationDbContext --> Handler : List<DomainUser>
        alt Invalid SharingUserIds
            Handler --> FolderTestEndpoints : Error: USER_NOTFOUND
            FolderTestEndpoints --> UI : 400 Bad Request (errorCode: USER_NOTFOUND)
            UI -> User : Error: Invalid user(s) in sharing list
        else Valid SharingUserIds
            Handler -> ApplicationDbContext : Query existing FolderUsers
            ApplicationDbContext -> Database : Query FolderUsers
            Database --> ApplicationDbContext : List<FolderUser>
            ApplicationDbContext --> Handler : List<FolderUser>
            loop For each SharingModel
                Handler -> ApplicationDbContext : Update or Add FolderUser
                ApplicationDbContext -> Database : Update/Insert FolderUser
            end
            Handler -> ApplicationDbContext : Remove FolderUsers for DeleteUserIds
            ApplicationDbContext -> Database : Delete FolderUsers
            Database --> ApplicationDbContext : Success
            ApplicationDbContext --> Handler : Guid
            Handler --> FolderTestEndpoints : Guid
            FolderTestEndpoints --> UI : 200 OK (ApiResponse<Guid>)
            UI -> User : Info: Sharing settings updated
        end
    end
end
@enduml