@startuml
actor User
participant "AI Generate UI" as UI
participant AiGenerateEndpoints
participant GenerateDocumentStructureCommandHandler as Handler
participant AiGenerateService
participant ApplicationDbContext
participant Database
participant PromptProvider

User -> UI : Upload PDF, click "Generate Structure"
UI -> AiGenerateEndpoints : POST /api/AiGenerate/DocumentStructure
AiGenerateEndpoints -> Handler : Handle(GenerateDocumentStructureCommand)
Handler -> AiGenerateService : UploadFileAsync(fileData)
AiGenerateService --> Handler : UploadResult (FileUri, FileName)
Handler -> PromptProvider : GetGenerateDocumentStructureSystemInstructionPrompt()
PromptProvider --> Handler : SystemInstruction
Handler -> ApplicationDbContext : Query currentUser by UserId
ApplicationDbContext -> Database : Query DomainUser
Database --> ApplicationDbContext : DomainUser
ApplicationDbContext --> Handler : DomainUser (currentUser)
alt Payment Locked
    Handler --> AiGenerateEndpoints : Error: PAYMENT_IN_PROGRESS
    AiGenerateEndpoints --> UI : 400 Bad Request (errorCode: PAYMENT_IN_PROGRESS)
    UI -> User : Error: Payment in progress, please wait
else Payment Not Locked
    Handler -> ApplicationDbContext : Set currentUser.IsPaymentLocked = true
    ApplicationDbContext -> Database : Update DomainUser
    Database --> ApplicationDbContext : Success
    Handler -> ApplicationDbContext : Query SystemSettings
    ApplicationDbContext -> Database : Query SystemSettings
    Database --> ApplicationDbContext : SystemSetting
    ApplicationDbContext --> Handler : SystemSetting
    alt System Setting Not Found
        Handler --> AiGenerateEndpoints : Error: SYSTEM_SETTING_NOT_FOUND
        AiGenerateEndpoints --> UI : 400 Bad Request (errorCode: SYSTEM_SETTING_NOT_FOUND)
        UI -> User : Error: System settings not found
    else System Setting Found
        activate Handler
        Handler -> AiGenerateService : CountTokenWithFileAsync(fileUri, systemInstruction, prompt)
        AiGenerateService --> Handler : TokenCount (minimumExpectedTokens)
        alt File Too Large (Tokens > MaxInputToken)
            Handler --> AiGenerateEndpoints : Error: AI_FILE_TOO_LARGE
            AiGenerateEndpoints --> UI : 400 Bad Request (errorCode: AI_FILE_TOO_LARGE)
            UI -> User : Error: File too large for AI processing
        else File Size OK
            Handler -> Handler : Calculate minimumTotalPoint (based on token costs and fixed fee)
            alt Insufficient Balance
                Handler --> AiGenerateEndpoints : Error: INSUFFICIENT_BALANCE
                AiGenerateEndpoints --> UI : 400 Bad Request (errorCode: INSUFFICIENT_BALANCE)
                UI -> User : Error: Insufficient balance
            else Sufficient Balance
                Handler -> AiGenerateService : SendPromptWithFileAsync(fileUri, systemInstruction, prompt)
                AiGenerateService --> Handler : AI_Response (result string)
                Handler -> ApplicationDbContext : Decrease currentUser.Balance
                ApplicationDbContext -> Database : Update DomainUser
                Database --> ApplicationDbContext : Success
                alt AI Response is not empty
                    Handler -> AiGenerateService : CountToken(result)
                    AiGenerateService --> Handler : OutputTokenCount
                    Handler -> ApplicationDbContext : Set currentUser.IsPaymentLocked = false
                    ApplicationDbContext -> Database : Update DomainUser
                    Database --> ApplicationDbContext : Success
                end
                Handler -> Handler : Extract JSON from AI Response
                alt AI Response contains "NO_STRUCTURE_FOUND"
                    Handler --> AiGenerateEndpoints : Error: NO_STRUCTURE_FOUND
                    AiGenerateEndpoints --> UI : 400 Bad Request (errorCode: NO_STRUCTURE_FOUND)
                    UI -> User : Error: No document structure found
                else JSON Deserialization Failed
                    Handler --> AiGenerateEndpoints : Error: GENERATE_CONTENT_FAILED
                    AiGenerateEndpoints --> UI : 500 Internal Server Error (errorCode: GENERATE_CONTENT_FAILED)
                    UI -> User : Error: Failed to generate document structure
                else JSON Deserialization Success
                    Handler --> AiGenerateEndpoints : DocumentStructureDto
                    AiGenerateEndpoints --> UI : 200 OK (ApiResponse<DocumentStructureDto>)
                    UI -> User : Show generated document structure
                end
            end
        end
        deactivate Handler
    end
finally
    Handler -> ApplicationDbContext : Set currentUser.IsPaymentLocked = false
    ApplicationDbContext -> Database : Update DomainUser
    Database --> ApplicationDbContext : Success
    Handler -> AiGenerateService : DeleteFileAsync(fileName)
    AiGenerateService --> Handler : Success
end
@enduml