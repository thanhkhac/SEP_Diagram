@startuml
actor User
participant "AI Generate UI" as UI
participant AiGenerateEndpoints
participant GenerateDocumentStructureCommandHandler as Handler
participant AiGenerateService
participant ApplicationDbContext
participant Database
participant PromptProvider

User -> UI : Upload PDF, click "Generate Structure"
activate UI

UI -> AiGenerateEndpoints : POST /api/AiGenerate/DocumentStructure
activate AiGenerateEndpoints

AiGenerateEndpoints -> Handler : Handle(GenerateDocumentStructureCommand)
activate Handler

Handler -> AiGenerateService : UploadFileAsync(fileData)
activate AiGenerateService
AiGenerateService --> Handler : UploadResult (FileUri, FileName)
deactivate AiGenerateService

Handler -> PromptProvider : GetGenerateDocumentStructureSystemInstructionPrompt()
activate PromptProvider
PromptProvider --> Handler : SystemInstruction
deactivate PromptProvider

Handler -> ApplicationDbContext : Query currentUser by UserId
activate ApplicationDbContext

ApplicationDbContext -> Database : Query DomainUser
activate Database
Database --> ApplicationDbContext : DomainUser
deactivate Database

ApplicationDbContext --> Handler : DomainUser (currentUser)
deactivate ApplicationDbContext

alt Payment Locked
    Handler --> AiGenerateEndpoints : Error: PAYMENT_IN_PROGRESS
    AiGenerateEndpoints --> UI : 400 Bad Request (PAYMENT_IN_PROGRESS)
    UI -> User : Error: Payment in progress
else Payment Not Locked
    Handler -> ApplicationDbContext : Set currentUser.IsPaymentLocked = true
    activate ApplicationDbContext
    ApplicationDbContext -> Database : Update DomainUser
    activate Database
    Database --> ApplicationDbContext : Success
    deactivate Database
    ApplicationDbContext --> Handler : Success
    deactivate ApplicationDbContext

    Handler -> ApplicationDbContext : Query SystemSettings
    activate ApplicationDbContext
    ApplicationDbContext -> Database : Query SystemSettings
    activate Database
    Database --> ApplicationDbContext : SystemSetting
    deactivate Database
    ApplicationDbContext --> Handler : SystemSetting
    deactivate ApplicationDbContext

    alt System Setting Not Found
        Handler --> AiGenerateEndpoints : Error: SYSTEM_SETTING_NOT_FOUND
        AiGenerateEndpoints --> UI : 400 Bad Request (SYSTEM_SETTING_NOT_FOUND)
        UI -> User : Error: System settings not found
    else System Setting Found
        Handler -> AiGenerateService : CountTokenWithFileAsync(fileUri, systemInstruction, prompt)
        activate AiGenerateService
        AiGenerateService --> Handler : TokenCount
        deactivate AiGenerateService

        alt File Too Large
            Handler --> AiGenerateEndpoints : Error: AI_FILE_TOO_LARGE
            AiGenerateEndpoints --> UI : 400 Bad Request (AI_FILE_TOO_LARGE)
            UI -> User : Error: File too large
        else File Size OK
            Handler -> Handler : Calculate minimumTotalPoint

            alt Insufficient Balance
                Handler --> AiGenerateEndpoints : Error: INSUFFICIENT_BALANCE
                AiGenerateEndpoints --> UI : 400 Bad Request (INSUFFICIENT_BALANCE)
                UI -> User : Error: Insufficient balance
            else Sufficient Balance
                Handler -> AiGenerateService : SendPromptWithFileAsync(...)
                activate AiGenerateService
                AiGenerateService --> Handler : AI_Response
                deactivate AiGenerateService

                Handler -> ApplicationDbContext : Decrease Balance
                activate ApplicationDbContext
                ApplicationDbContext -> Database : Update DomainUser
                activate Database
                Database --> ApplicationDbContext : Success
                deactivate Database
                ApplicationDbContext --> Handler : Success
                deactivate ApplicationDbContext

                Handler -> AiGenerateService : CountToken(result)
                activate AiGenerateService
                AiGenerateService --> Handler : OutputTokenCount
                deactivate AiGenerateService

                Handler -> Handler : Calculate output cost
                Handler -> ApplicationDbContext : Decrease Balance (output cost)
                activate ApplicationDbContext
                ApplicationDbContext -> Database : Update DomainUser
                activate Database
                Database --> ApplicationDbContext : Success
                deactivate Database
                ApplicationDbContext --> Handler : Success
                deactivate ApplicationDbContext

                Handler -> ApplicationDbContext : Set IsPaymentLocked = false
                activate ApplicationDbContext
                ApplicationDbContext -> Database : Update DomainUser
                activate Database
                Database --> ApplicationDbContext : Success
                deactivate Database
                ApplicationDbContext -> Database : SaveChanges()
                activate Database
                Database --> ApplicationDbContext : Success
                deactivate Database
                ApplicationDbContext --> Handler : Success
                deactivate ApplicationDbContext

                Handler -> Handler : Extract JSON from AI Response
                alt NO_STRUCTURE_FOUND
                    Handler --> AiGenerateEndpoints : Error: NO_STRUCTURE_FOUND
                    AiGenerateEndpoints --> UI : 400 Bad Request (NO_STRUCTURE_FOUND)
                    UI -> User : Error: No document structure found
                else if JSON Deserialization Failed
                    Handler --> AiGenerateEndpoints : Error: GENERATE_CONTENT_FAILED
                    AiGenerateEndpoints --> UI : 500 Internal Server Error (GENERATE_CONTENT_FAILED)
                    UI -> User : Error: Failed to generate structure
                else JSON Deserialization Success
                    Handler --> AiGenerateEndpoints : DocumentStructureDto
                    AiGenerateEndpoints --> UI : 200 OK
                    UI -> User : Show generated document structure
                end
            end
        end
    end
end

... Always cleanup ...
Handler -> ApplicationDbContext : Set IsPaymentLocked = false
activate ApplicationDbContext
ApplicationDbContext -> Database : Update DomainUser
activate Database
Database --> ApplicationDbContext : Success
deactivate Database
ApplicationDbContext --> Handler : Success
deactivate ApplicationDbContext

Handler -> AiGenerateService : DeleteFileAsync(fileName)
activate AiGenerateService
AiGenerateService --> Handler : Success
deactivate AiGenerateService

deactivate Handler
deactivate AiGenerateEndpoints
deactivate UI
@enduml
