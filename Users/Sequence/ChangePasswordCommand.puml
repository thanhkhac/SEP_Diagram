@startuml
actor User
participant "User Profile UI" as UI
participant UserEndpoints
participant ChangePasswordCommandHandler as Handler
participant IdentityService

User -> UI : Enter current and new password, click "Change Password"
UI -> UserEndpoints : PATCH /api/User/ChangePassword
UserEndpoints -> Handler : Handle(ChangePasswordCommand)
Handler -> IdentityService : ChangePasswordAsync(userId, currentPassword, newPassword)
alt Invalid Current Password
    IdentityService --> Handler : Error: INVALID_CREDENTIALS
    Handler --> UserEndpoints : Error: INVALID_CREDENTIALS
    UserEndpoints --> UI : 400 Bad Request (errorCode: INVALID_CREDENTIALS)
    UI -> User : Error: Invalid current password
else New Password Requirements Not Met
    IdentityService --> Handler : Error: PASSWORD_REQUIREMENTS_NOT_MET
    Handler --> UserEndpoints : Error: PASSWORD_REQUIREMENTS_NOT_MET
    UserEndpoints --> UI : 400 Bad Request (errorCode: PASSWORD_REQUIREMENTS_NOT_MET)
    UI -> User : Error: New password does not meet requirements
else Password Change Success
    IdentityService --> Handler : Success
    Handler --> UserEndpoints : Success
    UserEndpoints --> UI : 200 OK (ApiResponse<Unit>)
    UI -> User : Info: Password changed successfully
end
@enduml