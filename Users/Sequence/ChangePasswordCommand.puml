@startuml
actor User
participant "User Profile UI" as UI
participant UserEndpoints
participant ChangePasswordCommandHandler as Handler
participant IdentityService

User -> UI : Enter current and new password, click "Change Password"
activate UI
UI -> UserEndpoints : PATCH /api/User/ChangePassword
activate UserEndpoints
UserEndpoints -> Handler : Handle(ChangePasswordCommand)
activate Handler
Handler -> IdentityService : ChangePasswordAsync(userId, currentPassword, newPassword)
activate IdentityService
alt Invalid Current Password
    IdentityService --> Handler : Error: INVALID_CREDENTIALS
    deactivate IdentityService
    Handler --> UserEndpoints : Error: INVALID_CREDENTIALS
    UserEndpoints --> UI : 400 Bad Request (errorCode: INVALID_CREDENTIALS)
    UI -> User : Error: Invalid current password
else New Password Requirements Not Met
    IdentityService --> Handler : Error: PASSWORD_REQUIREMENTS_NOT_MET
    deactivate IdentityService
    Handler --> UserEndpoints : Error: PASSWORD_REQUIREMENTS_NOT_MET
    UserEndpoints --> UI : 400 Bad Request (errorCode: PASSWORD_REQUIREMENTS_NOT_MET)
    UI -> User : Error: New password does not meet requirements
else Password Change Success
    IdentityService --> Handler : Success
    deactivate IdentityService
    Handler --> UserEndpoints : Success
    UserEndpoints --> UI : 200 OK (ApiResponse<Unit>)
    UI -> User : Info: Password changed successfully
end
deactivate Handler
deactivate UserEndpoints
deactivate UI
@enduml