@startuml
actor User
participant "Learn UI" as UI <<UI>>
participant ":QuestionSetEndpoints" as QuestionSetEndpoints <<Controller>>
participant ":ResetQuestionSetHistoryCommandHandler" as ResetQuestionSetHistoryCommandHandler <<Handler>>
participant ":QuestionSetService" as QuestionSetService <<Service>>
participant ":UserQuestionSetHistoryService" as UserQuestionSetHistoryService <<Service>>
participant ":ApplicationDbContext" as ApplicationDbContext <<DbContext>>
participant Database

note right of ResetQuestionSetHistoryCommandHandler
  Managed by MediatR
end note

note right of QuestionSetService
  Managed by IoC
end note

note right of UserQuestionSetHistoryService
  Managed by IoC
end note

note right of ApplicationDbContext
  Managed by IoC
end note

User -> UI : Click "Reset history"
activate UI
UI -> QuestionSetEndpoints : DELETE /api/QuestionSet/{id}/LearnHistory
activate QuestionSetEndpoints
QuestionSetEndpoints -> ResetQuestionSetHistoryCommandHandler : Handle(ResetQuestionSetHistoryCommand)
deactivate QuestionSetEndpoints
activate ResetQuestionSetHistoryCommandHandler
ResetQuestionSetHistoryCommandHandler -> QuestionSetService : GetActiveQuestionSet(questionSetId)
deactivate ResetQuestionSetHistoryCommandHandler
activate QuestionSetService
QuestionSetService -> ApplicationDbContext : Query QuestionSet
deactivate QuestionSetService
activate ApplicationDbContext
ApplicationDbContext -> Database : Query QuestionSet
deactivate ApplicationDbContext
activate Database
Database --> ApplicationDbContext : QuestionSet
deactivate Database
activate ApplicationDbContext
ApplicationDbContext --> QuestionSetService : QuestionSet
deactivate ApplicationDbContext
activate QuestionSetService
QuestionSetService --> ResetQuestionSetHistoryCommandHandler : QuestionSet
deactivate QuestionSetService
activate ResetQuestionSetHistoryCommandHandler
alt Not found
    ResetQuestionSetHistoryCommandHandler -> QuestionSetEndpoints : Error: QUESTION_SET_NOT_FOUND
    deactivate ResetQuestionSetHistoryCommandHandler
    activate QuestionSetEndpoints
    QuestionSetEndpoints --> UI : 400 Bad Request { "error": "QUESTION_SET_NOT_FOUND" }
    deactivate QuestionSetEndpoints
    UI -> User : Display error: Question set not found
else Found
    activate ResetQuestionSetHistoryCommandHandler
    ResetQuestionSetHistoryCommandHandler -> QuestionSetService : CanUserViewQuestionSet(userId, questionSet)
    deactivate ResetQuestionSetHistoryCommandHandler
    activate QuestionSetService
    QuestionSetService -> ApplicationDbContext : Query Permission
    deactivate QuestionSetService
    activate ApplicationDbContext
    ApplicationDbContext -> Database : Query Permission
    deactivate ApplicationDbContext
    activate Database
    Database --> ApplicationDbContext : Permission
    deactivate Database
    activate ApplicationDbContext
    ApplicationDbContext --> QuestionSetService : Permission
    deactivate ApplicationDbContext
    activate QuestionSetService
    QuestionSetService --> ResetQuestionSetHistoryCommandHandler : bool
    deactivate QuestionSetService
    activate ResetQuestionSetHistoryCommandHandler
    alt No permission
        ResetQuestionSetHistoryCommandHandler -> QuestionSetEndpoints : Error: COMMON_FORBIDDEN
        deactivate ResetQuestionSetHistoryCommandHandler
        activate QuestionSetEndpoints
        QuestionSetEndpoints --> UI : 400 Bad Request { "error": "COMMON_FORBIDDEN" }
        deactivate QuestionSetEndpoints
        UI -> User : Display error: No permission
    else Allowed
        activate ResetQuestionSetHistoryCommandHandler
        ResetQuestionSetHistoryCommandHandler -> UserQuestionSetHistoryService : DeleteHistoriesByUserAndSetAsync(userId, questionSetId)
        deactivate ResetQuestionSetHistoryCommandHandler
        activate UserQuestionSetHistoryService
        UserQuestionSetHistoryService -> ApplicationDbContext : Delete UserQuestionSetHistories
        deactivate UserQuestionSetHistoryService
        activate ApplicationDbContext
        ApplicationDbContext -> Database : Delete UserQuestionSetHistories
        deactivate ApplicationDbContext
        activate Database
        Database --> ApplicationDbContext : Success
        deactivate Database
        activate ApplicationDbContext
        ApplicationDbContext --> UserQuestionSetHistoryService : Success
        deactivate ApplicationDbContext
        activate UserQuestionSetHistoryService
        UserQuestionSetHistoryService --> ResetQuestionSetHistoryCommandHandler : Guid
        deactivate UserQuestionSetHistoryService
        activate ResetQuestionSetHistoryCommandHandler
        ResetQuestionSetHistoryCommandHandler -> QuestionSetEndpoints : Guid
        deactivate ResetQuestionSetHistoryCommandHandler
        activate QuestionSetEndpoints
        QuestionSetEndpoints --> UI : 200 OK (ApiResponse<Guid>)
        deactivate QuestionSetEndpoints
        UI -> User : Display info: History reset
    end
end
deactivate UI

@enduml