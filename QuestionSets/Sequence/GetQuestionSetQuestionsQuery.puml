@startuml
actor User
participant "Question List UI" as UI
participant QuestionSetEndpoints
participant GetQuestionSetQuestionsQueryHandler as Handler
participant QuestionSetService
participant QuestionService
participant ApplicationDbContext
participant Database

User -> UI : View questions in set
activate UI
UI -> QuestionSetEndpoints : GET /api/QuestionSet/{id}/Questions
activate QuestionSetEndpoints
QuestionSetEndpoints -> Handler : Handle(GetQuestionSetQuestionsQuery)
activate Handler
Handler -> QuestionSetService : GetActiveQuestionSet(questionSetId)
activate QuestionSetService
QuestionSetService -> ApplicationDbContext : Query QuestionSet
activate ApplicationDbContext
ApplicationDbContext -> Database : Query QuestionSet
activate Database
Database --> ApplicationDbContext : QuestionSet
deactivate Database
ApplicationDbContext --> QuestionSetService : QuestionSet
deactivate ApplicationDbContext
QuestionSetService --> Handler : QuestionSet
deactivate QuestionSetService
alt Not found
    Handler --> QuestionSetEndpoints : Error: QUESTION_SET_NOT_FOUND
    QuestionSetEndpoints --> UI : 400 Bad Request (errorCode: QUESTION_SET_NOT_FOUND)
    UI -> User : Error: Question set not found
else Found
    Handler -> QuestionSetService : CanUserViewQuestionSet(userId, questionSet)
    activate QuestionSetService
    QuestionSetService -> ApplicationDbContext : Query Permission
    activate ApplicationDbContext
    ApplicationDbContext -> Database : Query Permission
    activate Database
    Database --> ApplicationDbContext : Permission
    deactivate Database
    ApplicationDbContext --> QuestionSetService : Permission
    deactivate ApplicationDbContext
    QuestionSetService --> Handler : bool
    deactivate QuestionSetService
    alt No permission
        Handler --> QuestionSetEndpoints : Error: COMMON_FORBIDDEN
        QuestionSetEndpoints --> UI : 400 Bad Request (errorCode: COMMON_FORBIDDEN)
        UI -> User : Error: No permission
    else Allowed
        Handler -> QuestionService : GetQuestionsBySetIdForDetailAsync(questionSetId, userId)
        activate QuestionService
        QuestionService -> ApplicationDbContext : Query Questions
        activate ApplicationDbContext
        ApplicationDbContext -> Database : Query Questions
        activate Database
        Database --> ApplicationDbContext : List<Question>
        deactivate Database
        ApplicationDbContext --> QuestionService : List<Question>
        deactivate ApplicationDbContext
        QuestionService --> Handler : List<QuestionResponseDto>
        deactivate QuestionService
        Handler --> QuestionSetEndpoints : List<QuestionResponseDto>
        QuestionSetEndpoints --> UI : 200 OK (ApiResponse<List<QuestionResponseDto>>)
        UI -> User : Show questions
    end
end
deactivate Handler
deactivate QuestionSetEndpoints
deactivate UI
@enduml