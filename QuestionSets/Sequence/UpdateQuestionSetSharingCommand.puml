@startuml
actor User
participant "Question Set Sharing UI" as UI <<UI>>
participant ":QuestionSetEndpoints" as QuestionSetEndpoints <<Controller>>
participant ":UpdateQuestionSetSharingCommandHandler" as UpdateQuestionSetSharingCommandHandler <<Handler>>
participant ":QuestionSetService" as QuestionSetService <<Service>>
participant ":ApplicationDbContext" as ApplicationDbContext <<DbContext>>
participant Database

note right of UpdateQuestionSetSharingCommandHandler
  Managed by MediatR
end note

note right of QuestionSetService
  Managed by IoC
end note

note right of ApplicationDbContext
  Managed by IoC
end note

User -> UI : Update sharing settings
activate UI
UI -> QuestionSetEndpoints : PATCH /api/QuestionSet/{id}/Sharing
activate QuestionSetEndpoints
QuestionSetEndpoints -> UpdateQuestionSetSharingCommandHandler : Handle(UpdateQuestionSetSharingCommand)
deactivate QuestionSetEndpoints
activate UpdateQuestionSetSharingCommandHandler
UpdateQuestionSetSharingCommandHandler -> QuestionSetService : GetActiveQuestionSet(id)
deactivate UpdateQuestionSetSharingCommandHandler
activate QuestionSetService
QuestionSetService -> ApplicationDbContext : Query QuestionSet
deactivate QuestionSetService
activate ApplicationDbContext
ApplicationDbContext -> Database : Query QuestionSet
deactivate ApplicationDbContext
activate Database
Database --> ApplicationDbContext : QuestionSet
deactivate Database
activate ApplicationDbContext
ApplicationDbContext --> QuestionSetService : QuestionSet
deactivate ApplicationDbContext
activate QuestionSetService
QuestionSetService --> UpdateQuestionSetSharingCommandHandler : QuestionSet
deactivate QuestionSetService
activate UpdateQuestionSetSharingCommandHandler
alt Question Set Not Found
    UpdateQuestionSetSharingCommandHandler -> QuestionSetEndpoints : Error: QUESTION_SET_NOT_FOUND
    deactivate UpdateQuestionSetSharingCommandHandler
    activate QuestionSetEndpoints
    QuestionSetEndpoints --> UI : 400 Bad Request { "error": "QUESTION_SET_NOT_FOUND" }
    deactivate QuestionSetEndpoints
    UI -> User : Display error: Question set not found
else Question Set Found
    activate UpdateQuestionSetSharingCommandHandler
    UpdateQuestionSetSharingCommandHandler -> UpdateQuestionSetSharingCommandHandler : Check if User is Owner
    alt Not Owner
        UpdateQuestionSetSharingCommandHandler -> QuestionSetEndpoints : Error: COMMON_FORBIDDEN
        deactivate UpdateQuestionSetSharingCommandHandler
        activate QuestionSetEndpoints
        QuestionSetEndpoints --> UI : 400 Bad Request { "error": "COMMON_FORBIDDEN" }
        deactivate QuestionSetEndpoints
        UI -> User : Display error: Not allowed to edit sharing
    else Is Owner
        activate UpdateQuestionSetSharingCommandHandler
        UpdateQuestionSetSharingCommandHandler -> ApplicationDbContext : Add, Update, Delete QuestionSetUser
        deactivate UpdateQuestionSetSharingCommandHandler
        activate ApplicationDbContext
        ApplicationDbContext -> Database : Apply changes
        deactivate ApplicationDbContext
        activate Database
        Database --> ApplicationDbContext : Success
        deactivate Database
        activate ApplicationDbContext
        ApplicationDbContext --> UpdateQuestionSetSharingCommandHandler : Updated QuestionSet
        deactivate ApplicationDbContext
        activate UpdateQuestionSetSharingCommandHandler
        UpdateQuestionSetSharingCommandHandler -> QuestionSetEndpoints : Guid
        deactivate UpdateQuestionSetSharingCommandHandler
        activate QuestionSetEndpoints
        QuestionSetEndpoints --> UI : 200 OK (ApiResponse<Guid>)
        deactivate QuestionSetEndpoints
        UI -> User : Display info: Sharing settings updated
    end
end
deactivate UI

@enduml