@startuml
actor User
participant "Test Template List UI" as UI <<UI>>
participant ":TestTemplateEndpoints" as TestTemplateEndpoints <<Controller>>
participant ":DeleteTestTemplateCommandHandler" as DeleteTestTemplateCommandHandler <<Handler>>
participant ":TestTemplateService" as TestTemplateService <<Service>>
participant ":ApplicationDbContext" as ApplicationDbContext <<DbContext>>
participant ":IdentityService" as IdentityService <<Service>>
participant Database

note right of DeleteTestTemplateCommandHandler
  Managed by MediatR
end note

note right of TestTemplateService
  Managed by IoC
end note

note right of ApplicationDbContext
  Managed by IoC
end note

note right of IdentityService
  Managed by IoC
end note

User -> UI : Click "Delete"
activate UI
UI -> TestTemplateEndpoints : DELETE /api/TestTemplate/{TestTemplateId}
activate TestTemplateEndpoints
TestTemplateEndpoints -> DeleteTestTemplateCommandHandler : Handle(DeleteTestTemplateCommand)
deactivate TestTemplateEndpoints
activate DeleteTestTemplateCommandHandler
DeleteTestTemplateCommandHandler -> ApplicationDbContext : Query TestTemplate by TestTemplateId
deactivate DeleteTestTemplateCommandHandler
activate ApplicationDbContext
ApplicationDbContext -> Database : Query TestTemplate
deactivate ApplicationDbContext
activate Database
Database --> ApplicationDbContext : TestTemplate
deactivate Database
activate ApplicationDbContext
ApplicationDbContext --> DeleteTestTemplateCommandHandler : TestTemplate
deactivate ApplicationDbContext
activate DeleteTestTemplateCommandHandler
alt Test Template Not Found
    DeleteTestTemplateCommandHandler -> TestTemplateEndpoints : Error: TEST_TEMPLATE_NOT_FOUND
    deactivate DeleteTestTemplateCommandHandler
    activate TestTemplateEndpoints
    TestTemplateEndpoints --> UI : 400 Bad Request { "error": "TEST_TEMPLATE_NOT_FOUND" }
    deactivate TestTemplateEndpoints
    UI -> User : Display error: Test template not found
else Test Template Found
    activate DeleteTestTemplateCommandHandler
    DeleteTestTemplateCommandHandler -> TestTemplateService : CanDeleteTestTemplate(testTemplateId)
    deactivate DeleteTestTemplateCommandHandler
    activate TestTemplateService
    TestTemplateService -> IdentityService : IsInAnyRoleAsync(userId, Administrator, Moderator)
    deactivate TestTemplateService
    activate IdentityService
    IdentityService --> TestTemplateService : bool (isAdmin)
    deactivate IdentityService
    activate TestTemplateService
    alt Is Admin
        TestTemplateService -> DeleteTestTemplateCommandHandler : true
    else Not Admin
        TestTemplateService -> ApplicationDbContext : Query TestTemplateUser (Owner)
        deactivate TestTemplateService
        activate ApplicationDbContext
        ApplicationDbContext -> Database : Query TestTemplateUser
        deactivate ApplicationDbContext
        activate Database
        Database --> ApplicationDbContext : TestTemplateUser
        deactivate Database
        activate ApplicationDbContext
        ApplicationDbContext --> TestTemplateService : TestTemplateUser
        deactivate ApplicationDbContext
        activate TestTemplateService
        TestTemplateService -> DeleteTestTemplateCommandHandler : bool (isOwner)
    end
    deactivate TestTemplateService
    activate DeleteTestTemplateCommandHandler
    alt No permission
        DeleteTestTemplateCommandHandler -> TestTemplateEndpoints : Error: USER_NOT_HAVE_PERMISSION_IN_TEST_TEMPLATE
        deactivate DeleteTestTemplateCommandHandler
        activate TestTemplateEndpoints
        TestTemplateEndpoints --> UI : 400 Bad Request { "error": "USER_NOT_HAVE_PERMISSION_IN_TEST_TEMPLATE" }
        deactivate TestTemplateEndpoints
        UI -> User : Display error: User does not have permission to delete this test template
    else Allowed
        activate DeleteTestTemplateCommandHandler
        DeleteTestTemplateCommandHandler -> ApplicationDbContext : Mark TestTemplate as Deleted
        deactivate DeleteTestTemplateCommandHandler
        activate ApplicationDbContext
        ApplicationDbContext -> Database : Update TestTemplate (IsDeleted = true)
        deactivate ApplicationDbContext
        activate Database
        Database --> ApplicationDbContext : Success
        deactivate Database
        activate ApplicationDbContext
        ApplicationDbContext --> DeleteTestTemplateCommandHandler : Guid
        deactivate ApplicationDbContext
        activate DeleteTestTemplateCommandHandler
        DeleteTestTemplateCommandHandler -> TestTemplateEndpoints : Guid
        deactivate DeleteTestTemplateCommandHandler
        activate TestTemplateEndpoints
        TestTemplateEndpoints --> UI : 200 OK (ApiResponse<Guid>)
        deactivate TestTemplateEndpoints
        UI -> User : Display info: Test template deleted successfully
    end
end
deactivate UI

@enduml