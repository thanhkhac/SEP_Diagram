@startuml
actor User
participant "Create Test Template UI" as UI <<UI>>
participant ":TestTemplateEndpoints" as TestTemplateEndpoints <<Controller>>
participant ":CreateTestTemplateCommandHandler" as CreateTestTemplateCommandHandler <<Handler>>
participant ":TestTemplateService" as TestTemplateService <<Service>>
participant ":ApplicationDbContext" as ApplicationDbContext <<DbContext>>
participant Database

note right of CreateTestTemplateCommandHandler
  Managed by MediatR
end note

note right of TestTemplateService
  Managed by IoC
end note

note right of ApplicationDbContext
  Managed by IoC
end note

User -> UI : Fill in info, add questions, click "Create"
activate UI
UI -> TestTemplateEndpoints : POST /api/TestTemplate
activate TestTemplateEndpoints
TestTemplateEndpoints -> CreateTestTemplateCommandHandler : Handle(CreateTestTemplateCommand)
deactivate TestTemplateEndpoints
activate CreateTestTemplateCommandHandler
CreateTestTemplateCommandHandler -> TestTemplateService : TryCheckQuestionAccessForTestTemplate(questions)
deactivate CreateTestTemplateCommandHandler
activate TestTemplateService
TestTemplateService -> ApplicationDbContext : Query Questions/Permissions
deactivate TestTemplateService
activate ApplicationDbContext
ApplicationDbContext -> Database : Query Questions/Permissions
deactivate ApplicationDbContext
activate Database
Database --> ApplicationDbContext : Questions/Permissions
deactivate Database
activate ApplicationDbContext
ApplicationDbContext --> TestTemplateService : Questions/Permissions
deactivate ApplicationDbContext
activate TestTemplateService
TestTemplateService --> CreateTestTemplateCommandHandler : Success/Error
deactivate TestTemplateService
activate CreateTestTemplateCommandHandler
alt Question Access Denied
    CreateTestTemplateCommandHandler -> TestTemplateEndpoints : Error: QUESTION_NOT_HAVE_ACCESS
    deactivate CreateTestTemplateCommandHandler
    activate TestTemplateEndpoints
    TestTemplateEndpoints --> UI : 400 Bad Request { "error": "QUESTION_NOT_HAVE_ACCESS" }
    deactivate TestTemplateEndpoints
    UI -> User : Display error: Some questions are not accessible or invalid
else Question Access Granted
    activate CreateTestTemplateCommandHandler
    CreateTestTemplateCommandHandler -> ApplicationDbContext : Add new TestTemplate and TestTemplateUser
    deactivate CreateTestTemplateCommandHandler
    activate ApplicationDbContext
    ApplicationDbContext -> Database : Insert TestTemplate, TestTemplateUser, Questions, TestTemplateQuestions
    deactivate ApplicationDbContext
    activate Database
    Database --> ApplicationDbContext : Success
    deactivate Database
    activate ApplicationDbContext
    ApplicationDbContext --> CreateTestTemplateCommandHandler : Guid
    deactivate ApplicationDbContext
    activate CreateTestTemplateCommandHandler
    CreateTestTemplateCommandHandler -> TestTemplateEndpoints : Guid
    deactivate CreateTestTemplateCommandHandler
    activate TestTemplateEndpoints
    TestTemplateEndpoints --> UI : 200 OK (ApiResponse<Guid>)
    deactivate TestTemplateEndpoints
    UI -> User : Display info: Test template created successfully
end
deactivate UI

@enduml